# Playwright Docker 抖音上传环境使用指南

## 📋 准备工作

### 1. 确保Docker已安装
```bash
# 检查Docker是否安装
docker --version
docker-compose --version
```

### 2. 创建必要目录
```bash
# 在宿主机上创建目录（重要！）
mkdir -p /vol1/1000/docker/playwright-browser
mkdir -p /vol1/1000/docker/playwright-browser/cookie
mkdir -p /vol1/1000/docker/playwright-browser/videos
```

## 🚀 第一步：启动Docker容器

### 1.1 启动容器
```bash
# 在项目目录下执行
docker-compose up -d
```

### 1.2 验证容器运行
```bash
# 检查容器状态
docker ps

# 应该看到类似输出：
# CONTAINER ID   IMAGE                                          PORTS                    NAMES
# xxxxxxxxxx     mcr.microsoft.com/playwright/python:v1.40.0   0.0.0.0:4701->8080/tcp   playwright-browser
```

### 1.3 确认端口访问
访问 http://669900.top:4701 确认容器可访问

## 🔧 第二步：安装环境依赖

### 2.1 进入容器
```bash
# 进入运行中的容器
docker exec -it playwright-browser bash

# 进入后应该看到容器内命令行：root@xxxxxxxxxx:/workspace#
```

### 2.2 快速安装（推荐方式）
```bash
# 在容器内执行以下命令：

# 确认在工作目录
pwd
# 输出应该是：/workspace

# 运行快速安装脚本
chmod +x 快速安装.sh
./快速安装.sh

# 等待安装完成（可能需要几分钟）
```

### 2.3 手动安装（备选方式）
如果快速安装脚本不工作，可以手动执行：

```bash
# 配置pip国内源
mkdir -p ~/.pip
cat > ~/.pip/pip.conf << EOF
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
trusted-host = pypi.tuna.tsinghua.edu.cn
timeout = 120
EOF

# 安装基础依赖
pip install playwright flask requests asyncio websockets aiohttp

# 设置playwright下载镜像
export PLAYWRIGHT_DOWNLOAD_HOST=https://npmmirror.com/mirrors/playwright

# 安装浏览器
python -m playwright install chromium
```

### 2.4 验证安装
```bash
# 测试playwright是否安装成功
python -c "
from playwright.sync_api import sync_playwright
print('Playwright安装成功!')
"

# 如果看到"Playwright安装成功!"说明环境准备完毕
```

## 📁 第三步：准备代码文件

### 3.1 复制代码到容器
**方法A：通过挂载目录**
```bash
# 在宿主机上，将您的代码复制到挂载目录
cp -r /path/to/your/douyin_code/* /vol1/1000/docker/playwright-browser/

# 文件会自动同步到容器的/workspace目录
```

**方法B：直接在容器内操作**
```bash
# 在容器内，如果您的代码在GitHub等地方
git clone https://github.com/your/douyin_project.git
# 或使用其他方式获取代码
```

### 3.2 确认文件同步
```bash
# 在容器内检查文件
ls -la /workspace
ls -la /workspace/cookie
ls -la /workspace/videos

# 应该看到您的代码文件
```

## 🎵 第四步：运行抖音上传

### 4.1 测试环境
```bash
# 在容器内测试基本功能
python -c "
from playwright.sync_api import sync_playwright
with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()
    page.goto('https://www.douyin.com')
    print('访问抖音成功!')
    browser.close()
"
```

### 4.2 运行您的脚本
```bash
# 运行您的主程序（假设是app.py）
python app.py

# 或运行其他脚本
python your_script.py
```

### 4.3 查看运行状态
```bash
# 如果需要查看详细日志
python app.py 2>&1 | tee upload.log

# 在另一个终端查看日志
docker exec -it playwright-browser tail -f upload.log
```

## 🔍 故障排除

### 问题1：容器无法启动
```bash
# 检查容器日志
docker logs playwright-browser

# 重新启动
docker-compose restart
```

### 问题2：无法访问挂载目录
```bash
# 检查目录权限
ls -la /vol1/1000/docker/playwright-browser/

# 如果权限不对，修改权限
chmod -R 755 /vol1/1000/docker/playwright-browser/
```

### 问题3：pip安装失败
```bash
# 手动指定镜像源
pip install 包名 -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或使用其他镜像源
pip install 包名 -i https://pypi.mirrors.ustc.edu.cn/simple/
```

### 问题4：playwright浏览器下载失败
```bash
# 重新安装浏览器
python -m playwright install chromium --force

# 或使用不同的下载源
export PLAYWRIGHT_DOWNLOAD_HOST=https://registry.npmmirror.com/-/binary/playwright/
python -m playwright install chromium
```

## 📚 常用命令参考

```bash
# 进入容器
docker exec -it playwright-browser bash

# 查看容器状态
docker ps

# 重启容器
docker-compose restart

# 停止容器
docker-compose down

# 启动容器
docker-compose up -d

# 查看容器日志
docker logs playwright-browser -f

# 在容器内运行单条命令
docker exec -it playwright-browser python your_script.py
```

## 📂 目录结构说明

```
宿主机目录                          容器内目录
/vol1/1000/docker/playwright-browser  →  /workspace
├── cookie/                           →  /workspace/cookie/
├── videos/                           →  /workspace/videos/
├── app.py                           →  /workspace/app.py
├── main.py                          →  /workspace/main.py
└── utils/                           →  /workspace/utils/
```

## ✅ 成功标志

当您看到以下输出时，说明环境搭建成功：
1. ✅ 容器正常运行：`docker ps` 显示容器状态为 `Up`
2. ✅ 可以进入容器：`docker exec -it playwright-browser bash` 成功
3. ✅ Playwright正常：运行测试代码无报错
4. ✅ 文件同步正常：容器内可以看到您的代码文件
5. ✅ 脚本运行正常：`python app.py` 可以正常启动 